<!DOCTYPE html><html><head><title>Eugene's Coding Blog | Rate Limiting An Express App</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><meta name="subject" content="The Coding Blog of Eugene Ghanizadeh Khoub"><meta name="robots" content="index,follow"><meta name="description" content="How to conduct a per-user rate limit on an Express-powered API? Well there is a naive solution, and there
is a more elegant one which requires thinking in streams and reactive programming."><meta name="keywords" content="programming, blog, journal, coding, eugene, Eugene Ghanizadeh Khoub, open-source, open source, software, development, developer, RxJS, Express, API, Rate Limit, Backend, Service, Stream, Reactive Programming, FRP"><meta name="theme-color" content="#212121"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" href="/techblog/favicon.ico"><link href="https://fonts.googleapis.com/css?family=Hind:400,700&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet"><style>
      body, input, button {
        font-family: 'Hind', sans-serif;
      }

      code, .hljs {
        font-family: 'Source Code Pro', 'Courier New', Courier, monospace;
      }

      .icon-font {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;  /* Preferred icon size */
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
      
        /* Support for all WebKit browsers. */
        -webkit-font-smoothing: antialiased;
        /* Support for Safari and Chrome. */
        text-rendering: optimizeLegibility;
      
        /* Support for Firefox. */
        -moz-osx-font-smoothing: grayscale;
      
        /* Support for IE. */
        font-feature-settings: 'liga';
      }

      .icon-font.outline {
        font-family: 'Material Icons Outlined';
      }
    </style><link href="/techblog/styles/codedoc-styles.css" rel="stylesheet"><script async="" defer="" src="/techblog/bundle/codedoc-bundle.js"></script><script>window.githubConfig={"repo":"techblog","user":"loreanvictor"}</script><style>.container{padding-top: 0 !important}</style><style>#-codedoc-toc { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px) }</style><meta name="twitter:title" content="Eugene's Coding Blog | Rate Limiting An Express App"><meta name="twitter:description" content="How to conduct a per-user rate limit on an Express-powered API? Well there is a naive solution, and there
is a more elegant one which requires thinking in streams and reactive programming."><meta name="twitter:image" content="https://images.unsplash.com/photo-1523286575777-21af045abec8?w=1993&amp;h=600&amp;fit=crop"><meta property="og:type" content="article"><meta property="og:title" content="Eugene's Coding Blog | Rate Limiting An Express App"><meta property="og:description" content="How to conduct a per-user rate limit on an Express-powered API? Well there is a naive solution, and there
is a more elegant one which requires thinking in streams and reactive programming."><meta property="og:image" content="https://images.unsplash.com/photo-1523286575777-21af045abec8?w=1993&amp;h=600&amp;fit=crop"></head><body><div class="header-0-0-5"><a class="watermark-0-0-4" href="https://coding.blog" target="_blank"><svg viewBox="0 0 701 443" version="1.1" xmlns="http://www.w3.org/2000/svg"><g id="coding.blog" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g transform="translate(-162.000000, -246.000000)" id="Shape"><path d="M538.081948,246.348452 L538.52402,246.445719 L538.52402,246.445719 L538.85529,246.526578 L538.85529,246.526578 L600.956012,263.165455 C602.767076,263.660918 604.526214,264.465865 606.146589,265.591976 C611.80881,269.527048 614.090389,276.211909 612.345003,282.123825 L538.2641,559.728905 C537.816127,561.562539 536.989561,563.335054 535.765607,564.944016 C530.70443,571.597248 520.764856,572.934442 513.564947,567.930724 C507.902727,563.995652 505.621148,557.310791 507.366534,551.398875 L577.145082,289.91439 L546.233523,281.631663 L462.305576,595.917544 L468.439004,634.645619 L493.907962,603.194573 C499.468987,596.327279 509.54413,595.268339 516.411424,600.829364 C523.278717,606.390389 524.337658,616.465532 518.776633,623.332826 L470.948283,682.395919 C466.887248,687.410879 460.418878,689.3283 454.55045,687.832105 L454.212574,687.741996 C448.224449,686.200133 443.421088,681.240355 442.392221,674.744345 L430.503202,599.680031 C430.418831,599.147339 430.361793,598.616628 430.331048,598.089327 C429.783912,595.705405 429.838457,593.220092 430.535776,590.858154 L519.361965,258.223717 L519.447729,257.889555 L519.447729,257.889555 L519.532157,257.586199 L519.627058,257.23399 C520.074771,255.398716 520.901697,253.624577 522.126677,252.014264 C525.828762,247.147643 532.141006,245.125338 538.081948,246.348452 Z M632.156421,656.157784 C640.992977,656.157784 648.156421,663.321228 648.156421,672.157784 C648.156421,680.99434 640.992977,688.157784 632.156421,688.157784 L528.156421,688.157784 C519.319865,688.157784 512.156421,680.99434 512.156421,672.157784 C512.156421,663.321228 519.319865,656.157784 528.156421,656.157784 L632.156421,656.157784 Z M699.234631,342.452157 L857.62655,500.844076 C863.874939,507.092464 863.874939,517.223104 857.62655,523.471493 L699.234631,681.863412 C692.986243,688.1118 682.855603,688.1118 676.607214,681.863412 C670.358826,675.615023 670.358826,665.484383 676.607214,659.235995 L823.686132,512.157077 L676.607214,365.079574 C670.358826,358.831185 670.358826,348.700545 676.607214,342.452157 C682.855603,336.203768 692.986243,336.203768 699.234631,342.452157 Z M347.705627,342.452157 C353.954016,348.700545 353.954016,358.831185 347.705627,365.079574 L200.62671,512.158491 L347.705627,659.235995 C353.954016,665.484383 353.954016,675.615023 347.705627,681.863412 C341.457239,688.1118 331.326599,688.1118 325.07821,681.863412 L166.686292,523.471493 C160.437903,517.223104 160.437903,507.092464 166.686292,500.844076 L325.07821,342.452157 C331.326599,336.203768 341.457239,336.203768 347.705627,342.452157 Z"></path></g></g></svg></a></div><div id="-codedoc-container" class="container"><script>window.source = {"base":"posts","path":"rate-limiting-an-express-app.md","namespace":"/techblog","title":{"base":"Eugene's Coding Blog","connector":" | "}}</script><div class="hero-0-0-11" data-target="desktop" style="margin-bottom: -188px"><img src="https://images.unsplash.com/photo-1523286575777-21af045abec8?w=1993&amp;h=600&amp;fit=crop" class="image-0-0-12" data-hero=""><span class="caption-0-0-13"></span></div><div class="hero-0-0-11" data-target="mobile" style="margin-bottom: -128px"><img src="https://images.unsplash.com/photo-1523286575777-21af045abec8?w=1990&amp;h=1200&amp;fit=crop" class="image-0-0-12" data-hero=""><span class="caption-0-0-13"></span></div><h1 class="h-0-0-14 white"><span style=" 
      text-shadow: 0 0 6px #0000009e; 
      font-size: 48px"><p>Rate Limiting An Express App</p></span></h1><div class="space-0-0-15" style="height: 72px"></div><p>Imagine we have an API with multiple end-points written in NodeJS and using Express. And we
want to implement a rate limit on this API for each user (pretty common for any API).</p><p>The general code-structure of that would look like something this:</p><pre class=""><code class="ts code-0-0-18" tabindex="0"><span class="wmbar-0-0-21"><span></span><span></span><span></span><span></span></span><div class="line-0-0-20 " data-content="import * as express from 'express';"><span class="lineCounter-0-0-19 prim">1</span><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> express <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">2</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">3</span></div><br><div class="line-0-0-20 " data-content="const router = express.Router();"><span class="lineCounter-0-0-19">4</span><span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19 prim">5</span></div><br><div class="line-0-0-20 " data-content="router.all('*', (req, res, next) => {"><span class="lineCounter-0-0-19">6</span>router<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-20 " data-content="  // TODO: apply rate limiting"><span class="lineCounter-0-0-19">7</span>  <span class="token comment">// TODO: apply rate limiting</span></div><br><div class="line-0-0-20 " data-content="});"><span class="lineCounter-0-0-19">8</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">9</span></div><br><div class="line-0-0-20 " data-content="// ..."><span class="lineCounter-0-0-19 prim">10</span><span class="token comment">// ...</span></div><br><div class="line-0-0-20 " data-content="// Rest of your API definition"><span class="lineCounter-0-0-19">11</span><span class="token comment">// Rest of your API definition</span></div><br><div class="line-0-0-20 " data-content="// ..."><span class="lineCounter-0-0-19">12</span><span class="token comment">// ...</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">13</span></div><br><div class="line-0-0-20 " data-content="export default router;"><span class="lineCounter-0-0-19 prim">14</span><span class="token keyword">export</span> <span class="token keyword">default</span> router<span class="token punctuation">;</span></div><br></code></pre><hr><h1 id="naive-solution" class="heading-0-0-16"><span class="anchor-0-0-17" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Naive Solution</h1><p>To apply a global 10 seconds rate limit, we could write the middleware code like this:</p><pre class=""><code class="ts code-0-0-18" tabindex="0"><span class="wmbar-0-0-21"><span></span><span></span><span></span><span></span></span><div class="line-0-0-20 " data-content="import * as express from 'express';"><span class="lineCounter-0-0-19 prim">1</span><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> express <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">2</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">3</span></div><br><div class="line-0-0-20 " data-content="const router = express.Router();"><span class="lineCounter-0-0-19">4</span><span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19 prim">5</span></div><br><div class="line-0-0-20 highlight" data-content="let lastReq;                                  // --> store the time of last request"><span class="lineCounter-0-0-19">6</span><span class="token keyword">let</span> lastReq<span class="token punctuation">;</span>                                  <span class="token comment">// --&gt; store the time of last request</span></div><br><div class="line-0-0-20 highlight" data-content=""><span class="lineCounter-0-0-19">7</span></div><br><div class="line-0-0-20 highlight" data-content="router.all('*', (req, res, next) => {"><span class="lineCounter-0-0-19">8</span>router<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-20 highlight" data-content="  const now = new Date();"><span class="lineCounter-0-0-19">9</span>  <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 highlight" data-content="  if (!lastReq || (lastReq - now) > 10000) {  // --> if it has been 10 seconds since last request"><span class="lineCounter-0-0-19 prim">10</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lastReq <span class="token operator">||</span> <span class="token punctuation">(</span>lastReq <span class="token operator">-</span> now<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// --&gt; if it has been 10 seconds since last request</span></div><br><div class="line-0-0-20 highlight" data-content="    lastReq = now;                            // --> update time of last request"><span class="lineCounter-0-0-19">11</span>    lastReq <span class="token operator">=</span> now<span class="token punctuation">;</span>                            <span class="token comment">// --&gt; update time of last request</span></div><br><div class="line-0-0-20 highlight" data-content="    next();                                   // --> pass to next handler (rest of the API)"><span class="lineCounter-0-0-19">12</span>    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                   <span class="token comment">// --&gt; pass to next handler (rest of the API)</span></div><br><div class="line-0-0-20 highlight" data-content="  } else {"><span class="lineCounter-0-0-19">13</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-20 highlight" data-content="    res.status(429).send();                   // --> otherwise, timeout"><span class="lineCounter-0-0-19">14</span>    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">429</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// --&gt; otherwise, timeout</span></div><br><div class="line-0-0-20 highlight" data-content="  }"><span class="lineCounter-0-0-19 prim">15</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-20 highlight" data-content="});"><span class="lineCounter-0-0-19">16</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">17</span></div><br><div class="line-0-0-20 " data-content="// ..."><span class="lineCounter-0-0-19">18</span><span class="token comment">// ...</span></div><br><div class="line-0-0-20 " data-content="// Rest of your API definition"><span class="lineCounter-0-0-19">19</span><span class="token comment">// Rest of your API definition</span></div><br><div class="line-0-0-20 " data-content="// ..."><span class="lineCounter-0-0-19 prim">20</span><span class="token comment">// ...</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">21</span></div><br><div class="line-0-0-20 " data-content="export default router;"><span class="lineCounter-0-0-19 prim">22</span><span class="token keyword">export</span> <span class="token keyword">default</span> router<span class="token punctuation">;</span></div><br></code></pre><p>This looks a bit hacky, since there is a global variable that is being updated by a middleware function. We could of-course
clean this up a bit by writing a custom middleware function:</p><div class="tabs-0-0-22"><script id="moOBGAesna">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("moOBGAesna", "RggwrDsCQt1aKOnRM7da+w==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div class="tab first selected" data-tab-title="middleware"><pre class=""><code class="ts code-0-0-18" tabindex="0"><span class="wmbar-0-0-21"><span></span><span></span><span></span><span></span></span><div class="line-0-0-20 " data-content="export function rateLimit(duration) {"><span class="lineCounter-0-0-19 prim">1</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">rateLimit</span><span class="token punctuation">(</span><span class="token parameter">duration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-20 " data-content=" let last;"><span class="lineCounter-0-0-19">2</span> <span class="token keyword">let</span> last<span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">3</span></div><br><div class="line-0-0-20 " data-content=" return (req, res, next) => {"><span class="lineCounter-0-0-19">4</span> <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-20 " data-content="   const now = new Date();"><span class="lineCounter-0-0-19 prim">5</span>   <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content="   if (!last || (last - now) > duration * 1000) {"><span class="lineCounter-0-0-19">6</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>last <span class="token operator">||</span> <span class="token punctuation">(</span>last <span class="token operator">-</span> now<span class="token punctuation">)</span> <span class="token operator">&gt;</span> duration <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-20 " data-content="     last = now;"><span class="lineCounter-0-0-19">7</span>     last <span class="token operator">=</span> now<span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content="     next();"><span class="lineCounter-0-0-19">8</span>     <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content="   } else {"><span class="lineCounter-0-0-19">9</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-20 " data-content="     res.status(429).send();"><span class="lineCounter-0-0-19 prim">10</span>     res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">429</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content="   }"><span class="lineCounter-0-0-19">11</span>   <span class="token punctuation">}</span></div><br><div class="line-0-0-20 " data-content=" }"><span class="lineCounter-0-0-19">12</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-20 " data-content="}"><span class="lineCounter-0-0-19 prim">13</span><span class="token punctuation">}</span></div><br></code></pre></div><div class="tab" data-tab-title="router"><pre class=""><code class="ts code-0-0-18" tabindex="0"><span class="wmbar-0-0-21"><span></span><span></span><span></span><span></span></span><div class="line-0-0-20 " data-content="import * as express from 'express';"><span class="lineCounter-0-0-19 prim">1</span><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> express <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content="import { rateLimit } from './rate-limit'; // @see tab:middleware"><span class="lineCounter-0-0-19">2</span><span class="token keyword">import</span> <span class="token punctuation">{</span> rateLimit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./rate-limit'</span><span class="token punctuation">;</span> <span class="token comment">// @see tab:middleware</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">3</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">4</span></div><br><div class="line-0-0-20 " data-content="const router = express.Router();"><span class="lineCounter-0-0-19 prim">5</span><span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">6</span></div><br><div class="line-0-0-20 highlight" data-content="router.all('*', rateLimit(10));"><span class="lineCounter-0-0-19">7</span>router<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token function">rateLimit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">8</span></div><br><div class="line-0-0-20 " data-content="// ..."><span class="lineCounter-0-0-19">9</span><span class="token comment">// ...</span></div><br><div class="line-0-0-20 " data-content="// Rest of your API definition"><span class="lineCounter-0-0-19 prim">10</span><span class="token comment">// Rest of your API definition</span></div><br><div class="line-0-0-20 " data-content="// ..."><span class="lineCounter-0-0-19">11</span><span class="token comment">// ...</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">12</span></div><br><div class="line-0-0-20 " data-content="export default router;"><span class="lineCounter-0-0-19 prim">13</span><span class="token keyword">export</span> <span class="token keyword">default</span> router<span class="token punctuation">;</span></div><br></code></pre></div></div><marker><br>

</marker><p>Now this seems much neater, but what we have implemented is a <em>global rate limit for anyone accessing the API</em>.
In other words, if Bob access the API, then Alice cannot access it for 10 seconds after that as well.</p><p>To fix that, we would need to authenticate the user making each request, and for simplicity lets assume
we have an <code>authenticate()</code> function that does exactly that job for us. Also let's assume that
<code>authenticate()</code> basically populates <code>req._.user</code>, which has an id, <code>req._.user.id</code>.</p><p>Now our code would look like this:</p><div class="tabs-0-0-22"><script id="DZzPqKXOjn">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("DZzPqKXOjn", "RggwrDsCQt1aKOnRM7da+w==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div class="tab first selected" data-tab-title="middleware"><pre class=""><code class="ts code-0-0-18" tabindex="0"><span class="wmbar-0-0-21"><span></span><span></span><span></span><span></span></span><div class="line-0-0-20 " data-content="export function rateLimit(duration) {"><span class="lineCounter-0-0-19 prim">1</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">rateLimit</span><span class="token punctuation">(</span><span class="token parameter">duration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-20 " data-content=" const last = {};                                     // --> keep a list of users with the timestamp of their last request"><span class="lineCounter-0-0-19">2</span> <span class="token keyword">const</span> last <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>                                     <span class="token comment">// --&gt; keep a list of users with the timestamp of their last request</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">3</span></div><br><div class="line-0-0-20 " data-content=" return (req, res, next) => {"><span class="lineCounter-0-0-19">4</span> <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-20 " data-content="   const now = new Date();"><span class="lineCounter-0-0-19 prim">5</span>   <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content="   if ("><span class="lineCounter-0-0-19">6</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span></div><br><div class="line-0-0-20 " data-content="     !(req._.user.id in last) ||                      // --> if the user has not made a request"><span class="lineCounter-0-0-19">7</span>     <span class="token operator">!</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>_<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id <span class="token keyword">in</span> last<span class="token punctuation">)</span> <span class="token operator">||</span>                      <span class="token comment">// --&gt; if the user has not made a request</span></div><br><div class="line-0-0-20 " data-content="     (last[req._.user.id] - now) > duration * 1000    // --> or it has been 10 seconds since their last request"><span class="lineCounter-0-0-19">8</span>     <span class="token punctuation">(</span>last<span class="token punctuation">[</span>req<span class="token punctuation">.</span>_<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">-</span> now<span class="token punctuation">)</span> <span class="token operator">&gt;</span> duration <span class="token operator">*</span> <span class="token number">1000</span>    <span class="token comment">// --&gt; or it has been 10 seconds since their last request</span></div><br><div class="line-0-0-20 " data-content="   ) {"><span class="lineCounter-0-0-19">9</span>   <span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-20 " data-content="     last[req._.user.id] = now;                       // --> update user's timestamp"><span class="lineCounter-0-0-19 prim">10</span>     last<span class="token punctuation">[</span>req<span class="token punctuation">.</span>_<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> now<span class="token punctuation">;</span>                       <span class="token comment">// --&gt; update user's timestamp</span></div><br><div class="line-0-0-20 " data-content="     next();                                          // --> handle user's request"><span class="lineCounter-0-0-19">11</span>     <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                          <span class="token comment">// --&gt; handle user's request</span></div><br><div class="line-0-0-20 " data-content="   } else {"><span class="lineCounter-0-0-19">12</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-20 " data-content="     res.status(429).send();                          // --> otherwise, timeout"><span class="lineCounter-0-0-19">13</span>     res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">429</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">// --&gt; otherwise, timeout</span></div><br><div class="line-0-0-20 " data-content="   }"><span class="lineCounter-0-0-19">14</span>   <span class="token punctuation">}</span></div><br><div class="line-0-0-20 " data-content=" }"><span class="lineCounter-0-0-19 prim">15</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-20 " data-content="}"><span class="lineCounter-0-0-19 prim">16</span><span class="token punctuation">}</span></div><br></code></pre></div><div class="tab" data-tab-title="router"><pre class=""><code class="ts code-0-0-18" tabindex="0"><span class="wmbar-0-0-21"><span></span><span></span><span></span><span></span></span><div class="line-0-0-20 " data-content="import * as express from 'express';"><span class="lineCounter-0-0-19 prim">1</span><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> express <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content="import { authenticate } from './auth';"><span class="lineCounter-0-0-19">2</span><span class="token keyword">import</span> <span class="token punctuation">{</span> authenticate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content="import { rateLimit } from './rate-limit'; // @see tab:middleware"><span class="lineCounter-0-0-19">3</span><span class="token keyword">import</span> <span class="token punctuation">{</span> rateLimit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./rate-limit'</span><span class="token punctuation">;</span> <span class="token comment">// @see tab:middleware</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">4</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19 prim">5</span></div><br><div class="line-0-0-20 " data-content="const router = express.Router();"><span class="lineCounter-0-0-19">6</span><span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">7</span></div><br><div class="line-0-0-20 highlight" data-content="router.all('*', authenticate(), rateLimit(10));"><span class="lineCounter-0-0-19">8</span>router<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">rateLimit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">9</span></div><br><div class="line-0-0-20 " data-content="// ..."><span class="lineCounter-0-0-19 prim">10</span><span class="token comment">// ...</span></div><br><div class="line-0-0-20 " data-content="// Rest of your API definition"><span class="lineCounter-0-0-19">11</span><span class="token comment">// Rest of your API definition</span></div><br><div class="line-0-0-20 " data-content="// ..."><span class="lineCounter-0-0-19">12</span><span class="token comment">// ...</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">13</span></div><br><div class="line-0-0-20 " data-content="export default router;"><span class="lineCounter-0-0-19 prim">14</span><span class="token keyword">export</span> <span class="token keyword">default</span> router<span class="token punctuation">;</span></div><br></code></pre></div></div><p>Besides still not being neat, we still have the issue that our <code>rateLimit()</code> middleware requires
another authentication middleware that does populate <code>req._.user</code> object. Brushing off that, it has a more pressing
and practical problem: the <code>last</code> object that the middleware creates is never cleaned up. There is an entry there for every
user that accesses the system, and without a cleanup mechanism it would keep growing in size, leading
to potential memory issues (or at least, over-usage).</p><p>To fix that, we could restructure our middleware to maintain a lock for each user and release it after a while:</p><pre class=""><code class="ts code-0-0-18" tabindex="0"><span class="wmbar-0-0-21"><span></span><span></span><span></span><span></span></span><div class="line-0-0-20 " data-content="export function rateLimit(duration) {"><span class="lineCounter-0-0-19 prim">1</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">rateLimit</span><span class="token punctuation">(</span><span class="token parameter">duration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-20 " data-content="  const lock = {};"><span class="lineCounter-0-0-19">2</span>  <span class="token keyword">const</span> lock <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content="  return (req, res, next) => {"><span class="lineCounter-0-0-19">3</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-20 " data-content="    if (req._.user.id in lock) {"><span class="lineCounter-0-0-19">4</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>_<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id <span class="token keyword">in</span> lock<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-20 " data-content="      res.status(429).send();"><span class="lineCounter-0-0-19 prim">5</span>      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">429</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content="    } else {"><span class="lineCounter-0-0-19">6</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-20 " data-content="      next();"><span class="lineCounter-0-0-19">7</span>      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content="      lock[req._.user.id] = true;"><span class="lineCounter-0-0-19">8</span>      lock<span class="token punctuation">[</span>req<span class="token punctuation">.</span>_<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content="      setTimeout(() => delete lock[req._.user.id], 1000 * duration);"><span class="lineCounter-0-0-19">9</span>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">delete</span> lock<span class="token punctuation">[</span>req<span class="token punctuation">.</span>_<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content="    }"><span class="lineCounter-0-0-19 prim">10</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-20 " data-content="  }"><span class="lineCounter-0-0-19">11</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-20 " data-content="}"><span class="lineCounter-0-0-19 prim">12</span><span class="token punctuation">}</span></div><br></code></pre><p>Now our solution works (and our middleware is also pretty small), but it has the following issues:</p><ul><li>Our middleware is not generic, as it is bound to the middlewares before that to set some identifier
on each request,</li><li>Our middleware code looks weird and it is not obvious what it does on the first look. A simple thing
like rate-limiting surely should be done in a simpler manner.</li></ul><hr><h1 id="stream-based-solution" class="heading-0-0-16"><span class="anchor-0-0-17" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Stream-Based Solution</h1><p>The main reason our approach bears those issues is that we are looking at one request
at a time, using the middleware's closure (i.e. <code>lock</code> or <code>last</code>) as an in-mem way of communicating
between those instances when we are making a decision for each request.</p><p>The nature of rate limiting however has more to do with streams of request than each single
request (it is a limit on the stream, not each single request). What we want to do is:</p><blockquote><ul><li>Do authentication on each incoming request (as before)</li><li>Split the incoming stream of requests per user</li><li>Throttle each user-request stream by a certain duration (10 seconds)</li></ul></blockquote><p>That seems simple enough, but to achieve it we would need to be able to work with
streams of requests. Express is however based on handling one request at a time (via a callback), 
so unfortunately we cannot have a code as neat as this simple description.</p><p>Or can't we?</p><p>Well, there is this neat library for working with streams called <a href="https://www.learnrxjs.io/">RxJS</a>. 
And there is a nice little library that creates a request stream for us based on Express's routers,
called <a href="https://loreanvictor.github.io/rxxpress/">RxXpress</a>. Combining the two, our rate limiting code
becomes something like this:</p><pre class=""><code class="ts code-0-0-18" tabindex="0"><span class="wmbar-0-0-21"><span></span><span></span><span></span><span></span></span><div class="line-0-0-20 " data-content="import { Router, next } from 'rxxpress';"><span class="lineCounter-0-0-19 prim">1</span><span class="token keyword">import</span> <span class="token punctuation">{</span> Router<span class="token punctuation">,</span> next <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxxpress'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content="import { throttleTime, groupBy, mergeMap } from 'rxjs/operators';"><span class="lineCounter-0-0-19">2</span><span class="token keyword">import</span> <span class="token punctuation">{</span> throttleTime<span class="token punctuation">,</span> groupBy<span class="token punctuation">,</span> mergeMap <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/operators'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">3</span></div><br><div class="line-0-0-20 " data-content="import { authenticate } from './auth';"><span class="lineCounter-0-0-19">4</span><span class="token keyword">import</span> <span class="token punctuation">{</span> authenticate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19 prim">5</span></div><br><div class="line-0-0-20 " data-content="const router = new Router();"><span class="lineCounter-0-0-19">6</span><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">7</span></div><br><div class="line-0-0-20 highlight" data-content="router.all('*').pipe("><span class="lineCounter-0-0-19">8</span>router<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span></div><br><div class="line-0-0-20 highlight" data-content="  use(authenticate()),                                  // --> conduct authentication"><span class="lineCounter-0-0-19">9</span>  <span class="token function">use</span><span class="token punctuation">(</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                  <span class="token comment">// --&gt; conduct authentication</span></div><br><div class="line-0-0-20 highlight" data-content="  groupBy(({req}) => req._.user.id),                    // --> split request stream based on user"><span class="lineCounter-0-0-19 prim">10</span>  <span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>req<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> req<span class="token punctuation">.</span>_<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token comment">// --&gt; split request stream based on user</span></div><br><div class="line-0-0-20 highlight" data-content="  mergeMap(group => group.pipe(throttleTime(10000))),   // --> throttle each split stream 10 seconds, then merge them together"><span class="lineCounter-0-0-19">11</span>  <span class="token function">mergeMap</span><span class="token punctuation">(</span><span class="token parameter">group</span> <span class="token operator">=&gt;</span> group<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">throttleTime</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">// --&gt; throttle each split stream 10 seconds, then merge them together</span></div><br><div class="line-0-0-20 highlight" data-content="  next()                                                // --> pass to next handler"><span class="lineCounter-0-0-19">12</span>  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                                <span class="token comment">// --&gt; pass to next handler</span></div><br><div class="line-0-0-20 highlight" data-content=").subscribe();"><span class="lineCounter-0-0-19">13</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">14</span></div><br><div class="line-0-0-20 " data-content="// ..."><span class="lineCounter-0-0-19 prim">15</span><span class="token comment">// ...</span></div><br><div class="line-0-0-20 " data-content="// Rest of your API definition"><span class="lineCounter-0-0-19">16</span><span class="token comment">// Rest of your API definition</span></div><br><div class="line-0-0-20 " data-content="// ..."><span class="lineCounter-0-0-19">17</span><span class="token comment">// ...</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">18</span></div><br><div class="line-0-0-20 " data-content="export default router.core;"><span class="lineCounter-0-0-19 prim">19</span><span class="token keyword">export</span> <span class="token keyword">default</span> router<span class="token punctuation">.</span>core<span class="token punctuation">;</span></div><br></code></pre><p>Ok that DOES look like our neat stream-based description, but if you are not familiar with RxJS, thats a lot
to unpack in one go. So lets break it down a bit:</p><marker><br>

</marker><pre class=""><code class="ts code-0-0-18" tabindex="0"><span class="wmbar-0-0-21"><span></span><span></span><span></span><span></span></span><div class="line-0-0-20 highlight" data-content="router.all('*').pipe(...).subscribe();"><span class="lineCounter-0-0-19 prim">1</span>router<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br></code></pre><p>Basically with the <a href="https://loreanvictor.github.io/rxxpress/router">RxXpress router</a>, 
each route is a stream of requests instead of a function accepting a callback.
Here we are basically saying that we want the stream of all requests (all methods, any path), and want to pipe it to some
operators (each operator is simply a function that is applied on the stream, pretty similar to piping shell commands),
and then subscribe to it (so we get those requests).</p><marker><br>

</marker><pre class=""><code class="ts code-0-0-18" tabindex="0"><span class="wmbar-0-0-21"><span></span><span></span><span></span><span></span></span><div class="line-0-0-20 " data-content="router.all('*').pipe("><span class="lineCounter-0-0-19 prim">1</span>router<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span></div><br><div class="line-0-0-20 highlight" data-content="  use(authenticate())"><span class="lineCounter-0-0-19">2</span>  <span class="token function">use</span><span class="token punctuation">(</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div><br><div class="line-0-0-20 " data-content="  // ..."><span class="lineCounter-0-0-19">3</span>  <span class="token comment">// ...</span></div><br><div class="line-0-0-20 " data-content=")"><span class="lineCounter-0-0-19 prim">4</span><span class="token punctuation">)</span></div><br></code></pre><p>We simply <a href="https://loreanvictor.github.io/rxxpress/operators/use">use</a> our nice <code>authenticate()</code> middleware on 
each incoming request.</p><marker><br>

</marker><pre class=""><code class="ts code-0-0-18" tabindex="0"><span class="wmbar-0-0-21"><span></span><span></span><span></span><span></span></span><div class="line-0-0-20 " data-content="router.all('*').pipe("><span class="lineCounter-0-0-19 prim">1</span>router<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span></div><br><div class="line-0-0-20 " data-content="  // ..."><span class="lineCounter-0-0-19">2</span>  <span class="token comment">// ...</span></div><br><div class="line-0-0-20 highlight" data-content="  groupBy(({req}) => req._.user.id)"><span class="lineCounter-0-0-19">3</span>  <span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>req<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> req<span class="token punctuation">.</span>_<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span></div><br><div class="line-0-0-20 " data-content="  // ..."><span class="lineCounter-0-0-19">4</span>  <span class="token comment">// ...</span></div><br><div class="line-0-0-20 " data-content=")"><span class="lineCounter-0-0-19 prim">5</span><span class="token punctuation">)</span></div><br></code></pre><p>The <a href="https://www.learnrxjs.io/learn-rxjs/operators/transformation/groupby"><code>groupBy</code></a> operator splits our initial
stream of our requests based on each user. The end result is a <em>stream of streams</em>, i.e. a <em>master stream</em>, which emits
<em>user request streams</em> (a stream of requests by that user).</p><blockquote><p>We are glossing over some details of <code>groupBy()</code> operator here.
You can checkout the following piece for more details on how to use <code>groupBy()</code> in
such a situation effectively:</p><script id="rMiNlDeQgK">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("rMiNlDeQgK", "GtM0qC4Maqb25jkJ2kxChA==", {"src":"/rxjs-group-by"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></blockquote><marker><br>

</marker><pre class=""><code class="ts code-0-0-18" tabindex="0"><span class="wmbar-0-0-21"><span></span><span></span><span></span><span></span></span><div class="line-0-0-20 " data-content="router.all('*').pipe("><span class="lineCounter-0-0-19 prim">1</span>router<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span></div><br><div class="line-0-0-20 " data-content="  // ..."><span class="lineCounter-0-0-19">2</span>  <span class="token comment">// ...</span></div><br><div class="line-0-0-20 highlight" data-content="  mergeMap(group => group.pipe(throttleTime(10000)))"><span class="lineCounter-0-0-19">3</span>  <span class="token function">mergeMap</span><span class="token punctuation">(</span><span class="token parameter">group</span> <span class="token operator">=&gt;</span> group<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">throttleTime</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div><br><div class="line-0-0-20 " data-content="  // ..."><span class="lineCounter-0-0-19">4</span>  <span class="token comment">// ...</span></div><br><div class="line-0-0-20 " data-content=")"><span class="lineCounter-0-0-19 prim">5</span><span class="token punctuation">)</span></div><br></code></pre><p>Ok this is a two-parter, so lets first look at the inner part:</p><pre class=""><code class="ts code-0-0-18" tabindex="0"><span class="wmbar-0-0-21"><span></span><span></span><span></span><span></span></span><div class="line-0-0-20 " data-content="group => group.pipe(throttleTime(10000))"><span class="lineCounter-0-0-19 prim">1</span><span class="token parameter">group</span> <span class="token operator">=&gt;</span> group<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">throttleTime</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div><br></code></pre><p>Remember how <code>groupBy()</code> split our stream? Each split stream ends up here, in the <code>group</code> variable. Each stream
is the stream of requests by each user, and we wanted to throttle it 10 seconds, so here is where
<a href="https://www.learnrxjs.io/learn-rxjs/operators/filtering/throttletime"><code>throttleTime()</code></a> operator becomes useful.
It simply passes on the first emission and drops the rest until given time is passed.</p><p>Now for the outer part: </p><pre class=""><code class="ts code-0-0-18" tabindex="0"><span class="wmbar-0-0-21"><span></span><span></span><span></span><span></span></span><div class="line-0-0-20 " data-content="router.all('*').pipe("><span class="lineCounter-0-0-19 prim">1</span>router<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span></div><br><div class="line-0-0-20 " data-content="  // ..."><span class="lineCounter-0-0-19">2</span>  <span class="token comment">// ...</span></div><br><div class="line-0-0-20 highlight" data-content="  mergeMap(...)"><span class="lineCounter-0-0-19">3</span>  <span class="token function">mergeMap</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span></div><br><div class="line-0-0-20 " data-content="  // ..."><span class="lineCounter-0-0-19">4</span>  <span class="token comment">// ...</span></div><br><div class="line-0-0-20 " data-content=")"><span class="lineCounter-0-0-19 prim">5</span><span class="token punctuation">)</span></div><br></code></pre><p>well the rest of our code doesn't need to be aware that we have split the original
stream of requests into separate per-user streams, so we need to <em>merge</em> those streams after throttling them
individually. That is where <a href="https://www.learnrxjs.io/learn-rxjs/operators/transformation/mergemap"><code>mergeMap()</code></a>
comes into play, as it merges all those streams into a single stream of requests again.</p><marker><br>

</marker><pre class=""><code class="ts code-0-0-18" tabindex="0"><span class="wmbar-0-0-21"><span></span><span></span><span></span><span></span></span><div class="line-0-0-20 " data-content="router.all('*').pipe("><span class="lineCounter-0-0-19 prim">1</span>router<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span></div><br><div class="line-0-0-20 " data-content="  // ..."><span class="lineCounter-0-0-19">2</span>  <span class="token comment">// ...</span></div><br><div class="line-0-0-20 " data-content="  next()"><span class="lineCounter-0-0-19">3</span>  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-20 " data-content=")"><span class="lineCounter-0-0-19 prim">4</span><span class="token punctuation">)</span></div><br></code></pre><p>Well every request that gets to this point (and is not dropped by throttling), should be passed
to the next request handler in line, and that is precisely what <a href="https://loreanvictor.github.io/rxxpress/operators/next"><code>next()</code></a>
does.</p><hr><h1 id="pros--cons" class="heading-0-0-16"><span class="anchor-0-0-17" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Pros &amp; Cons</h1><p>So lets look at our two solutions side by side:</p><div class="tabs-0-0-22"><script id="HbCEwIpFCA">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("HbCEwIpFCA", "RggwrDsCQt1aKOnRM7da+w==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div class="tab first selected" data-tab-title="streaming solution"><pre class=""><code class="ts code-0-0-18" tabindex="0"><span class="wmbar-0-0-21"><span></span><span></span><span></span><span></span></span><div class="line-0-0-20 " data-content="import { Router, next } from 'rxxpress';"><span class="lineCounter-0-0-19 prim">1</span><span class="token keyword">import</span> <span class="token punctuation">{</span> Router<span class="token punctuation">,</span> next <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxxpress'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content="import { throttleTime, groupBy, mergeMap } from 'rxjs/operators';"><span class="lineCounter-0-0-19">2</span><span class="token keyword">import</span> <span class="token punctuation">{</span> throttleTime<span class="token punctuation">,</span> groupBy<span class="token punctuation">,</span> mergeMap <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/operators'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">3</span></div><br><div class="line-0-0-20 " data-content="import { authenticate } from './auth';"><span class="lineCounter-0-0-19">4</span><span class="token keyword">import</span> <span class="token punctuation">{</span> authenticate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19 prim">5</span></div><br><div class="line-0-0-20 " data-content="const router = new Router();"><span class="lineCounter-0-0-19">6</span><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">7</span></div><br><div class="line-0-0-20 " data-content="router.all('*').pipe("><span class="lineCounter-0-0-19">8</span>router<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span></div><br><div class="line-0-0-20 " data-content="  use(authenticate()),                                  // --> conduct authentication"><span class="lineCounter-0-0-19">9</span>  <span class="token function">use</span><span class="token punctuation">(</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                  <span class="token comment">// --&gt; conduct authentication</span></div><br><div class="line-0-0-20 " data-content="  groupBy(({req}) => req._.user.id),                    // --> split request stream based on user"><span class="lineCounter-0-0-19 prim">10</span>  <span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>req<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> req<span class="token punctuation">.</span>_<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token comment">// --&gt; split request stream based on user</span></div><br><div class="line-0-0-20 " data-content="  mergeMap(group => group.pipe(throttleTime(10000))),   // --> throttle each split stream 10 seconds, then merge them together"><span class="lineCounter-0-0-19">11</span>  <span class="token function">mergeMap</span><span class="token punctuation">(</span><span class="token parameter">group</span> <span class="token operator">=&gt;</span> group<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">throttleTime</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">// --&gt; throttle each split stream 10 seconds, then merge them together</span></div><br><div class="line-0-0-20 " data-content="  next()                                                // --> pass to next handler"><span class="lineCounter-0-0-19">12</span>  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                                <span class="token comment">// --&gt; pass to next handler</span></div><br><div class="line-0-0-20 " data-content=").subscribe();"><span class="lineCounter-0-0-19">13</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">14</span></div><br><div class="line-0-0-20 " data-content="// ..."><span class="lineCounter-0-0-19 prim">15</span><span class="token comment">// ...</span></div><br><div class="line-0-0-20 " data-content="// Rest of your API definition"><span class="lineCounter-0-0-19">16</span><span class="token comment">// Rest of your API definition</span></div><br><div class="line-0-0-20 " data-content="// ..."><span class="lineCounter-0-0-19">17</span><span class="token comment">// ...</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">18</span></div><br><div class="line-0-0-20 " data-content="export default router.core;"><span class="lineCounter-0-0-19 prim">19</span><span class="token keyword">export</span> <span class="token keyword">default</span> router<span class="token punctuation">.</span>core<span class="token punctuation">;</span></div><br></code></pre></div><div class="tab" data-tab-title="naive solution"><pre class="with-bar"><code class="ts code-0-0-18" tabindex="0"><span class="wmbar-0-0-21"><span></span><span></span><span></span><span>router code</span></span><div class="line-0-0-20 " data-content="import * as express from 'express';"><span class="lineCounter-0-0-19 prim">1</span><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> express <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content="import { authenticate } from './auth';"><span class="lineCounter-0-0-19">2</span><span class="token keyword">import</span> <span class="token punctuation">{</span> authenticate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content="import { rateLimit } from './rate-limit'; // @see tab:middleware"><span class="lineCounter-0-0-19">3</span><span class="token keyword">import</span> <span class="token punctuation">{</span> rateLimit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./rate-limit'</span><span class="token punctuation">;</span> <span class="token comment">// @see tab:middleware</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">4</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19 prim">5</span></div><br><div class="line-0-0-20 " data-content="const router = express.Router();"><span class="lineCounter-0-0-19">6</span><span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">7</span></div><br><div class="line-0-0-20 " data-content="router.all('*', authenticate(), rateLimit(10));"><span class="lineCounter-0-0-19">8</span>router<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">rateLimit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">9</span></div><br><div class="line-0-0-20 " data-content="// ..."><span class="lineCounter-0-0-19 prim">10</span><span class="token comment">// ...</span></div><br><div class="line-0-0-20 " data-content="// Rest of your API definition"><span class="lineCounter-0-0-19">11</span><span class="token comment">// Rest of your API definition</span></div><br><div class="line-0-0-20 " data-content="// ..."><span class="lineCounter-0-0-19">12</span><span class="token comment">// ...</span></div><br><div class="line-0-0-20 " data-content=""><span class="lineCounter-0-0-19">13</span></div><br><div class="line-0-0-20 " data-content="export default router;"><span class="lineCounter-0-0-19 prim">14</span><span class="token keyword">export</span> <span class="token keyword">default</span> router<span class="token punctuation">;</span></div><br></code></pre><pre class="with-bar"><code class="ts code-0-0-18" tabindex="0"><span class="wmbar-0-0-21"><span></span><span></span><span></span><span>middleware code</span></span><div class="line-0-0-20 " data-content="export function rateLimit(duration) {"><span class="lineCounter-0-0-19 prim">1</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">rateLimit</span><span class="token punctuation">(</span><span class="token parameter">duration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-20 " data-content="  const lock = {};"><span class="lineCounter-0-0-19">2</span>  <span class="token keyword">const</span> lock <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content="  return (req, res, next) => {"><span class="lineCounter-0-0-19">3</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-20 " data-content="    if (req._.user.id in lock) {"><span class="lineCounter-0-0-19">4</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>_<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id <span class="token keyword">in</span> lock<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-20 " data-content="      res.status(400).send();"><span class="lineCounter-0-0-19 prim">5</span>      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content="    } else {"><span class="lineCounter-0-0-19">6</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-20 " data-content="      next();"><span class="lineCounter-0-0-19">7</span>      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content="      lock[req._.user.id] = true;"><span class="lineCounter-0-0-19">8</span>      lock<span class="token punctuation">[</span>req<span class="token punctuation">.</span>_<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content="      setTimeout(() => delete lock[req._.user.id], 1000 * duration);"><span class="lineCounter-0-0-19">9</span>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">delete</span> lock<span class="token punctuation">[</span>req<span class="token punctuation">.</span>_<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-20 " data-content="    }"><span class="lineCounter-0-0-19 prim">10</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-20 " data-content="  }"><span class="lineCounter-0-0-19">11</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-20 " data-content="}"><span class="lineCounter-0-0-19 prim">12</span><span class="token punctuation">}</span></div><br></code></pre></div></div><p>As you can see, the streaming solution is much more precise and elegant. However, not only
it requires more knowledge of a library like RxJS, it generally demands thinking in terms of
streams, which is not familiar for us programmers as most of our experience is with problems
that we think imparatively about, i.e. in terms of instructions that are executed one after
another.</p><p>This different paradigm of course becomes a serious barrier of entry for a lot of people, 
causing them to actually prefer the naive solution to the stream-based one. <em>And that is OK</em>. However,
I hope seeing whats on the other side of that barrier encourages you to try to overcome
that barrier and enjoy the elegance of streams and reactive programming.</p><hr><script id="ujGXYjpJct">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("ujGXYjpJct", "xgCwfJkntxB0D9ZowbcD2Q==", {"src":"github"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><marker><br>

</marker><p><em>Hero image by <a href="https://unsplash.com/@makariostang">Makarios Tang</a> from <a href="https://unsplash.com">Unsplash</a></em></p><div hidden="" data-ignore-text="" data-meta-override="description" data-meta-override-behavior="replace"><p>How to conduct a per-user rate limit on an Express-powered API? Well there is a naive solution, and there
is a more elegant one which requires thinking in streams and reactive programming.</p></div><div hidden="" data-ignore-text="" data-meta-override="keywords" data-meta-override-behavior="extend"><p>RxJS, Express, API, Rate Limit, Backend, Service, Stream, Reactive Programming, FRP</p></div><div class="contentnav-0-0-10" data-no-search=""><a href="#naive-solution" class="h1" data-content-highlight="naive-solution">Naive Solution</a><a href="#stream-based-solution" class="h1" data-content-highlight="stream-based-solution">Stream-Based Solution</a><a href="#pros--cons" class="h1" data-content-highlight="pros--cons">Pros &amp; Cons</a></div></div><div id="-codedoc-toc" class="toc-0-0-7"><div class="content-0-0-8"><p><a href="/techblog/">Home</a></p><div class="collapse-0-0-3 "><script id="DiNjykYFJr">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("DiNjykYFJr", "wRRYUuUbpv0Nq418wsaswA==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div class="label" onclick="this.parentElement.classList.toggle('open')"><span class="text">On Reactive Programming</span><span class="icon-font closed">chevron_right</span></div><div class="content"><p><a href="/techblog/rxjs-error-handling">Error Handling in RxJS</a>
<a href="/techblog/rate-limiting-an-express-app">Rate Limiting an Express App</a>
<a href="/techblog/rxjs-group-by">How RxJS <code>groupBy()</code> Works</a></p></div></div><div class="collapse-0-0-3 "><script id="JfZNkGOybU">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("JfZNkGOybU", "wRRYUuUbpv0Nq418wsaswA==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div class="label" onclick="this.parentElement.classList.toggle('open')"><span class="text">Yet Another Frontend Framework</span><span class="icon-font closed">chevron_right</span></div><div class="content"><p><a href="/techblog/yaff/part1">Part1: Why?</a>
<a href="/techblog/yaff/part2">Part2: JSX</a></p></div></div><div class="collapse-0-0-3 "><script id="aHedFvGqma">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("aHedFvGqma", "wRRYUuUbpv0Nq418wsaswA==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div class="label" onclick="this.parentElement.classList.toggle('open')"><span class="text">Other Articles</span><span class="icon-font closed">chevron_right</span></div><div class="content"><p><a href="/techblog/why-medium-doesnt-work-for-programmers">Why Medium Doesn't Work for Programmers</a>
<a href="/techblog/diversity-is-not-a-progressive-value">Diversity is NOT a Progressive Value</a></p></div></div></div></div><div class="footer-0-0-6"><div class="left"><script id="fUKOOrCVlk">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("fUKOOrCVlk", "Y3CwRdEdOr4c/7giJ+aw9A==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div><div class="main"><div class="inside"></div></div><div class="right"><script id="ZWobGKJDID">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("ZWobGKJDID", "RvE5o2QfOK5J3QVF7Tklvg==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div></div><script id="mNHZdjvrDH">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("mNHZdjvrDH", "Q4JLHVOQZMeIjlyFQgRaUQ==", {"namespace":"/techblog"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></body></html>